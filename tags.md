# 📘 Справочник специальных тегов docxgen

В шаблонах docxgen используются не только функции-модификаторы (`|money`, `|plural`, `|declension` и др.),  
но и встроенные **структурные теги**, управляющие вставками, пробелами, таблицами и циклами.  
Они обрабатываются внутри движка (`ProcessTrimTags`, `ResolveIncludes`, `ProcessUnWrapParagraphTags`, `ExecuteTemplate`).

---

## 🔖 Базовые маркеры

| Синтаксис               | Назначение | Пример                                              |
|-------------------------|-------------|-----------------------------------------------------|
| `{tag}`                 | Обычный плейсхолдер данных. | `{fio}` → «Иванов Иван Иванович»                    |
| `{tag\|mod1\|mod2:arg}` | Тег с модификаторами. | <pre>```{fio\|abbr\|prefix:`гражданин `}```</pre>   |
| `{.field}`              | Доступ к полю внутри `{range}`. | <pre>```{range .clients}{.name\|abbr}{end}```</pre> |

---

## 🧩 Управление пробелами и переносами

| Синтаксис | Назначение | Пример                                                          |
|------------|-------------|-----------------------------------------------------------------|
| `{-tag-}` | Удаляет пробелы и табы вокруг тега. | `слово {-tag-} слово` → `словотекстслово`                       |
| `{~tag~}` | Удаляет пробелы, табы и переносы вокруг тега. | ```строка {tag~}\n\n\nстрока``` → `строка текстстрока` |
| `{-tag}` / `{tag-}` | Обрезает пробелы только с одной стороны. | `{tag-} слово` → `текстслово`                     |

---

## 🧱 Блочные теги и вставки

| Синтаксис | Назначение | Пример |
|------------|-------------|--------|
| `{*tag*}` | "Разворачивает" параграф в отдельный блок. | `{*include_block*}` |
| `[include/file.docx]` | Вставка содержимого `<w:body>` из внешнего DOCX. | `[include/blocks/sign.docx]` |
| `[include/file.docx/table/2]` | Вставка второй таблицы из файла. | `[include/report.docx/table/2]` |
| `[include/file.docx/p/3]` | Вставка третьего параграфа. | `[include/text.docx/p/3]` |

📄 Поддерживаемые фрагменты:
- `body` — всё содержимое документа;
- `table` — таблицы (`1..N`);
- `p` или `paragraph` — параграфы (`1..N`).

Файлы `.docx` ищутся относительно каталога шаблона.  
Пути защищены через `SecureJoin`, чтобы исключить выход за пределы каталога проекта.

---

## 📊 Таблицы и циклы

| Синтаксис | Назначение | Пример |
|------------|-------------|--------|
| `[table/name]` | Начало определения табличного блока. | `[table/budget_report]` |
| `[/table]` | Конец табличного блока. | `[/table]` |
| `{range .collection}{...}{end}` | Перебор элементов списка (аналог Go templates). | `{range .clients}{.name|abbr}{end}` |
| `{range .clients}[include/blocks/sign.docx]{end}` | Вставка внешнего блока для каждого элемента коллекции. | `{range .clients}[include/blocks/sign.docx]{end}` |
| `{n}`, `{annotation}`, `{deadline}`, `{price|money}` | Теги, используемые внутри строк таблицы. | `{price|money}` |

---

### 🧩 Как это работает

- `[table/name] ... [/table]` объявляет шаблон таблицы, который движок клонирует для каждой строки данных с ключом `name` в JSON.
- Каждый элемент массива `budget_report` из данных подставляется внутрь этой таблицы.
- Вложенные `{range}` могут использоваться как внутри таблицы, так и вне её — например, для повторения подписных блоков.

**Пример таблицы:**

<pre>
[table/budget_report]
╔══════╦═════════════════════════════════════╦═══════════════╦═══════════════╗
║ Этап ║                Срок                 ║   Описание    ║   Стоимость   ║
╠══════╩═════════════════════════════════════╩═══════════════╩═══════════════╣
║                  {title_sub_block} (подзаголовок секции)                   ║
╠══════╦═════════════════════════════════════╦═══════════════╦═══════════════╣
║  {n} ║ {deadline|date_format:`02.01.2006`} ║ {annotation}  ║ {price|money} ║
╚══════╩═════════════════════════════════════╩═══════════════╩═══════════════╝
[/table]
</pre>
→ при генерации создаёт таблицу с данными из массива `budget_report`.

---

📘 **Пример комбинированного цикла:**

```
{range .clients}[include/blocks/sign.docx]{end}
```

⟶ Для каждого клиента из массива `clients` будет вставлен блок `sign.docx`,  
который сам содержит внутренние теги (`{.name}`, `{.phone}` и т.д.).

---

🧩 Внутри циклов доступны:
- `.field` — текущее значение поля структуры (`{.name}`);
- `.index` — порядковый номер (если предусмотрено в шаблоне);
- вложенные модификаторы (`|abbr`, `|nowrap`, `|declension` и др.).

---

## 🧭 Специальные элементы

| Синтаксис                | Описание                                                    | Пример                                      |
|--------------------------|-------------------------------------------------------------|---------------------------------------------|
| `{project.code\|qrcode}` | Вставляет QR-код с параметрами позиционирования и размером. | ```{link\|qrcode:`8%`:`5/5`:`border`}```    |
| `{range ...}{end}`       | Перебор коллекций (аналог Go templates).                    | `{range .clients}{.name} — {.phone}{end}`   |
| `{~}` / `{-}`            | Управление пробелами и переносами внутри других тегов.      | `текст {~fio-} текст 2`                     |

---

## ⚙️ Порядок обработки

1. **RepairTags** — восстанавливает `{}` и `[]`, если Word разделил их на несколько `<w:t>`.
2. **ProcessUnWrapParagraphTags** — превращает `{*tag*}` в отдельные блочные вставки.
3. **ResolveIncludes** — подставляет `[include/...]` перед выполнением шаблона.
4. **ProcessTrimTags** — структурно обрабатывает `{~}` и `{-}`, удаляя пробелы.
5. **ExecuteTemplate** — применяет Go-шаблон с модификаторами (`|money`, `|abbr`, `|declension` и др.).
