package rusnum

import (
	"strings"
)

// Gender defines grammatical gender used for the lowest (units) group.
// Higher groups use their intrinsic gender (e.g., "тысяча" — feminine).
type Gender int

const (
	Masc Gender = iota
	Fem
	Neut
)

func (g Gender) String() string {
	switch g {
	case Masc:
		return "masculine"
	case Fem:
		return "feminine"
	case Neut:
		return "neuter"
	}
	return "?"
}

// Case enumerates Russian grammatical cases.
type Case int

const (
	Nom  Case = iota // nominative
	Gen              // genitive
	Dat              // dative
	Acc              // accusative
	Ins              // instrumental
	Prep             // prepositional
)

// NullStyle controls how 0 is rendered.
type NullStyle int

const (
	ZeroNul NullStyle = iota // "нуль"
	ZeroNol                  // "ноль"
)

// Options control inflection.
type Options struct {
	Gender          Gender
	Case            Case
	Null            NullStyle
	InsEightAltForm bool // if true, use "восемью" / "восемьюдесятью" variants
}

// Option is a functional option for ToWords/Format.
type Option func(*Options)

func WithGender(g Gender) Option       { return func(o *Options) { o.Gender = g } }
func WithCase(c Case) Option           { return func(o *Options) { o.Case = c } }
func WithNullStyle(s NullStyle) Option { return func(o *Options) { o.Null = s } }
func WithInsEightAlt(v bool) Option    { return func(o *Options) { o.InsEightAltForm = v } }

// ToWords converts an integer to Russian words with inflection.
// Supports up to 10^36 (ундциллионы). Negative numbers are prefixed with "минус".
func ToWords(n int, opts ...Option) string {
	cfg := Options{Gender: Masc, Case: Nom, Null: ZeroNul}
	for _, fn := range opts {
		fn(&cfg)
	}

	if n == 0 {
		if cfg.Null == ZeroNul {
			return pick(tableZeroNul, cfg.Case)
		}
		return pick(tableZeroNol, cfg.Case)
	}

	if n < 0 {
		return "минус " + ToWords(-n, opts...)
	}

	// Break the number into triplets (thousands, millions, etc.)
	groups := splitThousands(n)

	var parts []string

	// Go from the oldest to the lowest (the last element of the array is the largest)
	for groupIdx := len(groups) - 1; groupIdx >= 0; groupIdx-- {
		val := groups[groupIdx]
		if val == 0 {
			continue
		}

		// Determining the genus for the group
		g := groupGender(groupIdx, cfg.Gender)

		// Assembling a triplet
		part := spellTriplet(val, g, cfg)

		// Add a megaword (тысяча, миллион, миллиард...)
		if groupIdx > 0 && groupIdx < len(mega) {
			mw := megaWord(groupIdx, val, cfg.Case)
			if mw != "" {
				part += " " + mw
			}
		}

		parts = append(parts, part)
	}

	return strings.Join(parts, " ")
}

// ---- core rendering ----

func splitThousands(n int) []int {
	if n == 0 {
		return nil
	}
	var res []int
	for n > 0 {
		res = append(res, n%1000)
		n /= 1000
	}
	return res
}

func groupGender(group int, base Gender) Gender {
	if group == 0 {
		return base
	}
	if group == 1 {
		return Fem
	} // тысяча
	return Masc // миллион, миллиард, ... — masculine gender
}

func spellTriplet(x int, gen Gender, cfg Options) string {
	var parts []string

	h := x / 100
	t := (x / 10) % 10
	u := x % 10

	if h > 0 {
		parts = append(parts, pick(tableHundreds[h], cfg.Case))
	}

	if t == 1 { // teens
		parts = append(parts, pick(tableTeens[u], cfg.Case))
	} else {
		if t > 0 {
			if t == 8 && (cfg.Case == Ins || cfg.Case == Prep) && cfg.InsEightAltForm {
				parts = append(parts, pick(tableTensAlt8[t], cfg.Case))
			} else {
				parts = append(parts, pick(tableTens[t], cfg.Case))
			}
		}
		if u > 0 {
			parts = append(parts, unitWord(u, gen, cfg.Case, cfg.InsEightAltForm))
		}
	}

	return strings.Join(parts, " ")
}

func unitWord(u int, g Gender, c Case, alt8 bool) string {
	if u == 1 || u == 2 {
		// gender-sensitive 1/2
		row := tableUnit12[u][g]
		return pick(row, c)
	}

	// Special logic for 8 in the creative:
	// std (alt8=false) → «восьмью», alt (alt8=true) → «восемью»
	if u == 8 && c == Ins {
		if alt8 {
			return "восемью"
		}
		return "восьмью"
	}

	return pick(tableUnits[u], c)
}

func megaWord(groupIdx, value int, c Case) string {
	if groupIdx <= 0 || groupIdx >= len(mega) {
		return ""
	}
	forms := mega[groupIdx]
	if len(forms) == 0 {
		return ""
	}
	idx := pluralIndex(value)
	return pick(forms[idx], c)
}

// pluralIndex returns 0 for singular (1), 1 for few (2-4), 2 for many (others)
func pluralIndex(n int) int {
	n %= 100
	if n >= 11 && n <= 14 {
		return 2
	}
	switch n % 10 {
	case 1:
		return 0
	case 2, 3, 4:
		return 1
	default:
		return 2
	}
}

func pick(row []string, c Case) string { return row[c] }

// ---- data tables (independently authored) ----

// order of cases: Nom, Gen, Dat, Acc, Ins, Prep

var tableZeroNul = []string{"нуль", "нуля", "нулю", "нуль", "нулём", "нуле"}
var tableZeroNol = []string{"ноль", "ноля", "нолю", "ноль", "нолём", "ноле"}

// Units 3..9 have gender-independent forms; 1 and 2 have gender variants.
var tableUnits = map[int][]string{
	3: {"три", "трёх", "трём", "три", "тремя", "трёх"},
	4: {"четыре", "четырёх", "четырём", "четыре", "четырьмя", "четырёх"},
	5: {"пять", "пяти", "пяти", "пять", "пятью", "пяти"},
	6: {"шесть", "шести", "шести", "шесть", "шестью", "шести"},
	7: {"семь", "семи", "семи", "семь", "семью", "семи"},
	8: {"восемь", "восьми", "восьми", "восемь", "восемью", "восьми"},
	9: {"девять", "девяти", "девяти", "девять", "девятью", "девяти"},
}

// Unit 1 & 2 per gender
var tableUnit12 = map[int]map[Gender][]string{
	1: {
		Masc: {"один", "одного", "одному", "один", "одним", "одном"},
		Fem:  {"одна", "одной", "одной", "одну", "одной", "одной"},
		Neut: {"одно", "одного", "одному", "одно", "одним", "одном"},
	},
	2: {
		Masc: {"два", "двух", "двум", "два", "двумя", "двух"},
		Fem:  {"две", "двух", "двум", "две", "двумя", "двух"},
		Neut: {"два", "двух", "двум", "два", "двумя", "двух"},
	},
}

// Teens (10-19) by unit index (0..9)
var tableTeens = [][]string{
	{"десять", "десяти", "десяти", "десять", "десятью", "десяти"},
	{"одиннадцать", "одиннадцати", "одиннадцати", "одиннадцать", "одиннадцатью", "одиннадцати"},
	{"двенадцать", "двенадцати", "двенадцати", "двенадцать", "двенадцатью", "двенадцати"},
	{"тринадцать", "тринадцати", "тринадцати", "тринадцать", "тринадцатью", "тринадцати"},
	{"четырнадцать", "четырнадцати", "четырнадцати", "четырнадцать", "четырнадцатью", "четырнадцати"},
	{"пятнадцать", "пятнадцати", "пятнадцати", "пятнадцать", "пятнадцатью", "пятнадцати"},
	{"шестнадцать", "шестнадцати", "шестнадцати", "шестнадцать", "шестнадцатью", "шестнадцати"},
	{"семнадцать", "семнадцати", "семнадцати", "семнадцать", "семнадцатью", "семнадцати"},
	{"восемнадцать", "восемнадцати", "восемнадцати", "восемнадцать", "восемнадцатью", "восемнадцати"},
	{"девятнадцать", "девятнадцати", "девятнадцати", "девятнадцать", "девятнадцатью", "девятнадцати"},
}

// Tens (20,30,...,90) with case forms. Index 0..9, 0 unused, 1==10 provided for completeness.
var tableTens = [][]string{
	{"", "", "", "", "", ""},
	{"десять", "десяти", "десяти", "десять", "десятью", "десяти"},
	{"двадцать", "двадцати", "двадцати", "двадцать", "двадцатью", "двадцати"},
	{"тридцать", "тридцати", "тридцати", "тридцать", "тридцатью", "тридцати"},
	{"сорок", "сорока", "сорока", "сорок", "сорока", "сорока"},
	{"пятьдесят", "пятидесяти", "пятидесяти", "пятьдесят", "пятьюдесятью", "пятидесяти"},
	{"шестьдесят", "шестидесяти", "шестидесяти", "шестьдесят", "шестьюдесятью", "шестидесяти"},
	{"семьдесят", "семидесяти", "семидесяти", "семьдесят", "семьюдесятью", "семидесяти"},
	{"восемьдесят", "восьмидесяти", "восьмидесяти", "восемьдесят", "восьмьюдесятью", "восьмидесяти"},
	{"девяносто", "девяноста", "девяноста", "девяносто", "девяноста", "девяноста"},
}

// Alternative instrumental form for 80: "восемьюдесятью" (used when InsEightAltForm and Ins case)
var tableTensAlt8 = [][]string{
	{"", "", "", "", "", ""},
	{"десять", "десяти", "десяти", "десять", "десятью", "десяти"},
	{"двадцать", "двадцати", "двадцати", "двадцать", "двадцатью", "двадцати"},
	{"тридцать", "тридцати", "тридцати", "тридцать", "тридцатью", "тридцати"},
	{"сорок", "сорока", "сорока", "сорок", "сорока", "сорока"},
	{"пятьдесят", "пятидесяти", "пятидесяти", "пятьдесят", "пятьюдесятью", "пятидесяти"},
	{"шестьдесят", "шестидесяти", "шестидесяти", "шестьдесят", "шестьюдесятью", "шестидесяти"},
	{"семьдесят", "семидесяти", "семидесяти", "семьдесят", "семьюдесятью", "семидесяти"},
	{"восемьдесят", "восьмидесяти", "восьмидесяти", "восемьдесят", "восемьюдесятью", "восьмидесяти"},
	{"девяносто", "девяноста", "девяноста", "девяносто", "девяноста", "девяноста"},
}

var tableHundreds = [][]string{
	{"", "", "", "", "", ""},
	{"сто", "ста", "ста", "сто", "ста", "ста"},
	{"двести", "двухсот", "двумстам", "двести", "двумястами", "двухстах"},
	{"триста", "трёхсот", "трёмстам", "триста", "тремястами", "трёхстах"},
	{"четыреста", "четырёхсот", "четырёмстам", "четыреста", "четырьмястами", "четырёхстах"},
	{"пятьсот", "пятисот", "пятистам", "пятьсот", "пятьюстами", "пятистах"},
	{"шестьсот", "шестисот", "шестистам", "шестьсот", "шестьюстами", "шестистах"},
	{"семьсот", "семисот", "семистам", "семьсот", "семьюстами", "семистах"},
	{"восемьсот", "восьмисот", "восьмистам", "восемьсот", "восемьюстами", "восьмистах"},
	{"девятьсот", "девятисот", "девятистам", "девятьсот", "девятьюстами", "девятистах"},
}

// Mega units: index corresponds to group (1=>thousand, 2=>million, ...)
// For each mega we provide 3 plural rows (1, few, many), each with 6 case forms.
var mega = [][][]string{
	{}, // 0 - units
	{ // 1 - тысяча (Fem)
		{"тысяча", "тысячи", "тысяче", "тысячу", "тысячей", "тысяче"},
		{"тысячи", "тысяч", "тысячам", "тысячи", "тысячами", "тысячах"},
		{"тысяч", "тысяч", "тысячам", "тысяч", "тысячами", "тысячах"},
	},
	{ // 2 - миллион (Masc)
		{"миллион", "миллиона", "миллиону", "миллион", "миллионом", "миллионе"},
		{"миллиона", "миллионов", "миллионам", "миллиона", "миллионами", "миллионах"},
		{"миллионов", "миллионов", "миллионам", "миллионов", "миллионами", "миллионах"},
	},
	{ // 3 - миллиард
		{"миллиард", "миллиарда", "миллиарду", "миллиард", "миллиардом", "миллиарде"},
		{"миллиарда", "миллиардов", "миллиардам", "миллиарда", "миллиардами", "миллиардах"},
		{"миллиардов", "миллиардов", "миллиардам", "миллиардов", "миллиардами", "миллиардах"},
	},
	{ // 4 - триллион
		{"триллион", "триллиона", "триллиону", "триллион", "триллионом", "триллионе"},
		{"триллиона", "триллионов", "триллионам", "триллиона", "триллионами", "триллионах"},
		{"триллионов", "триллионов", "триллионам", "триллионов", "триллионами", "триллионах"},
	},
	{ // 5 - квадриллион
		{"квадриллион", "квадриллиона", "квадриллиону", "квадриллион", "квадриллионом", "квадриллионе"},
		{"квадриллиона", "квадриллионов", "квадриллионам", "квадриллиона", "квадриллионами", "квадриллионах"},
		{"квадриллионов", "квадриллионов", "квадриллионам", "квадриллионов", "квадриллионами", "квадриллионах"},
	},
	{ // 6 - квинтиллион
		{"квинтиллион", "квинтиллиона", "квинтиллиону", "квинтиллион", "квинтиллионом", "квинтиллионе"},
		{"квинтиллиона", "квинтиллионов", "квинтиллионам", "квинтиллиона", "квинтиллионами", "квинтиллионах"},
		{"квинтиллионов", "квинтиллионов", "квинтиллионам", "квинтиллионов", "квинтиллионами", "квинтиллионах"},
	},
	{ // 7 - секстиллион
		{"секстиллион", "секстиллиона", "секстиллиону", "секстиллион", "секстиллионом", "секстиллионе"},
		{"секстиллиона", "секстиллионов", "секстиллионам", "секстиллиона", "секстиллионами", "секстиллионах"},
		{"секстиллионов", "секстиллионов", "секстиллионам", "секстиллионов", "секстиллионами", "секстиллионах"},
	},
	{ // 8 - септиллион
		{"септиллион", "септиллиона", "септиллиону", "септиллион", "септиллионом", "септиллионе"},
		{"септиллиона", "септиллионов", "септиллионам", "септиллиона", "септиллионами", "септиллионах"},
		{"септиллионов", "септиллионов", "септиллионам", "септиллионов", "септиллионами", "септиллионах"},
	},
	{ // 9 - октиллион
		{"октиллион", "октиллиона", "октиллиону", "октиллион", "октиллионом", "октиллионе"},
		{"октиллиона", "октиллионов", "октиллионам", "октиллиона", "октиллионами", "октиллионах"},
		{"октиллионов", "октиллионов", "октиллионам", "октиллионов", "октиллионами", "октиллионах"},
	},
	{ // 10 - нониллион
		{"нониллион", "нониллиона", "нониллиону", "нониллион", "нониллионом", "нониллионе"},
		{"нониллиона", "нониллионов", "нониллионам", "нониллиона", "нониллионами", "нониллионах"},
		{"нониллионов", "нониллионов", "нониллионам", "нониллионов", "нониллионами", "нониллионах"},
	},
	{ // 11 - дециллион
		{"дециллион", "дециллиона", "дециллиону", "дециллион", "дециллионом", "дециллионе"},
		{"дециллиона", "дециллионов", "дециллионам", "дециллиона", "дециллионами", "дециллионах"},
		{"дециллионов", "дециллионов", "дециллионам", "дециллионов", "дециллионами", "дециллионах"},
	},
	{ // 12 - ундециллион
		{"ундециллион", "ундециллиона", "ундециллиону", "ундециллион", "ундециллионом", "ундециллионе"},
		{"ундециллиона", "ундециллионов", "ундециллионам", "ундециллиона", "ундециллионами", "ундециллионах"},
		{"ундециллионов", "ундециллионов", "ундециллионам", "ундециллионов", "ундециллионами", "ундециллионах"},
	},
}
